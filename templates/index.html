{% extends "layout.html" %}
{% block title %}chatsovellus{% endblock %}
{% block content %}
    <div class="content">
        <h1>tervetuloa chatsovellukseen</h1>
        <hr>
        <h2>keskustelualueet</h2>
        <p>keskustelualueita: {{ count_categories }}</p>
        {% if admin %}
        <div class="login-box">
            <p><strong>luo uusi keskustelualue</strong></p>
            <form action="/new_category" method="POST">
                <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                <input type="text" name="category_name" placeholder="otsikko" maxlength="50" required>
                <div class="radio-group">
                    <div>
                        <label for="is_secret0">kaikille avoin</label>
                        <input type="radio" id="is_secret0" name="is_secret" value="0" checked>
                    </div>
                    <div>
                        <label for="is_secret1">salainen</label>
                        <input type="radio" id="is_secret1" name="is_secret" value="1">
                    </div>
                </div>
                <input type="submit" value="luo" class="plain-button">
            </form>
        </div>
    </div>  
        </div>
        {% endif %}
        {% for category in categories %}
        <div class="message-box">
            <a href="/{{ category.category_name }}"><h2>{{ category.category_name }}</h2></a>
            {% if admin %}
            <label>
                <input type="checkbox" class="toggle-edit-options" data-category-id="{{ category.category_id }}"> 
                editoi
            </label>
            <div class="category-edit-options" style="display: none;">
                <form action="/edit_category" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                    <input type="hidden" name="category_id" value="{{ category.category_id }}">
                    <input type="text" name="category_name" placeholder="otsikko" value="{{ category.category_name }}" maxlength="50" required> 
                    <p><label>
                        <input type="radio" id="is_secret0" name="is_secret" value="0" class="is_secret_open" 
                        {% if category.is_secret == 0 %}checked{% endif %}>avoin
                    </label>
                    <label>
                        <input type="radio" id="is_secret1" name="is_secret" value="1" class="is_secret_secret"
                        {% if category.is_secret == 1 %}checked{% endif %}>salainen
                    </label></p>
                    <div class="secret-users">
                        alueelle pääsevät käyttäjät: <br>
                        {% for user in users %}
                            <input type="checkbox" name="user_ids" value="{{ user.user_id }}"
                            {% if category.allowed_users %}
                            {% if user.user_id in category.allowed_users %}checked{% endif %}
                            {% endif %}> 
                            {{ user.username }} <br>
                        {% endfor %}
                    </div>
                    <p><input type="submit" value="päivitä"></p>
                </form>
                <form action="/delete_category" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                    <input type="hidden" name="category_id" value="{{ category.category_id }}">
                    <input type="submit" value="poista" class="delete-button"/>
                </form>
            </div>
            {% endif %}
            <p>viestiketjuja: {{ category.thread_count }}</p>
            <p>viestejä: {{ category.message_count }}</p>
            {% if category.last_message_time %}
            <p>viimeisin viesti: {{  category.last_message_time }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    <script>
        function toggleEditOptions() {
            var editOptions = document.querySelectorAll('.category-edit-options');
            editOptions.forEach(function(options) {
                var checkbox = options.previousElementSibling.querySelector('.toggle-edit-options');
                options.style.display = checkbox.checked ? 'block' : 'none';
            });
        }
        function toggleSecretSections() {
            var secretSections = document.querySelectorAll('.secret-users');
            secretSections.forEach(function(section) {
                var isSecretRadio = section.closest('form').querySelector('.is_secret_secret');
                if (isSecretRadio.checked) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }
        document.querySelectorAll('.toggle-edit-options').forEach(function(checkbox) {
            checkbox.addEventListener('change', toggleEditOptions);
        });
        document.querySelectorAll('.is_secret_open, .is_secret_secret').forEach(function(radio) {
            radio.addEventListener('change', toggleSecretSections);
        });
        toggleEditOptions();
        toggleSecretSections();

        const requiredFields = document.querySelectorAll("input[required], textarea[required]");
        requiredFields.forEach(field => {
            field.addEventListener("invalid", function(event) {
                field.setCustomValidity("Tekstikenttä ei saa olla tyhjä");
            });
            field.addEventListener("input", function(event) {
                field.setCustomValidity("");
            });
        });
    </script>
{% endblock %}